---
title: "Data preparation"
output:
  pdf_document: default
---

# Instructions

- You only need to submit the .Rmd of this file, not a PDF.

- You should __comment__ your code clearly to show what you've done to prepare the data.

- The purpose of this file is to use the data in the `data-raw` folder to create the data you will use in the report. The data you will use in the report should be saved in the `data` folder. It is good professional practice to make sure you're never directly modifying your raw data, but instead creating new datasets based on merges/manipulations that you need to reuse.

- Make sure you've taken a look at the hints for the web scraping and census API. 

- You may find the `write_rds()` function from the `readr` package helpful (it is loaded as part of the `tidyverse`).

- You do not need to keep the structure below.

# Set up

```{r, libraries}
# Set up any libraries you need
library(dplyr)
library(tidyverse)
library(ggplot2)
```

# Loading client data

```{r}
# load the data
break_glass_in_case_of_emergency <- readRDS("data-raw/break_glass_in_case_of_emergency.Rds")

cust_dev <- readRDS("data-raw/cust_dev.Rds")

cust_sleep <- readRDS("data-raw/cust_sleep.Rds")

customer <- readRDS("data-raw/customer.Rds")

device <- readRDS("data-raw/device.Rds")

```

# Getting external data

## Web scraping industry data

```{r}
# These are the libraries I find useful for webscraping
library(tidyverse)
library(polite)
library(rvest)

url <- "https://fitnesstrackerinfohub.netlify.app/"

# Make sure this code is updated appropriately to provide 
# informative user_agent details
target <- bow(url,
              user_agent = "liza.bolton@utoronto.ca for STA303/1002 project",
              force = TRUE)

# Any details provided in the robots text on crawl delays and 
# which agents are allowed to scrape
target

html <- scrape(target)

device_data <- html %>% 
  html_elements("table") %>% 
  html_table() %>% 
  pluck(1) # added, in case you're getting a list format

```

# Census API

```{r}
# install.packages("cancensus")
library(cancensus)


options(cancensus.api_key = "CensusMapper_cf78c5571bf66af9d889cac93d9ef013",
        cancensus.cache_path = "cache") # this sets a folder for your cache


# get all regions as at the 2016 Census (2020 not up yet)
regions <- list_census_regions(dataset = "CA16")

regions_filtered <-  regions %>% 
  filter(level == "CSD") %>% # Figure out what CSD means in Census data
  as_census_region_list()

# This can take a while
# We want to get household median income
census_data_csd <- get_census(dataset='CA16', regions = regions_filtered,
                          vectors=c("v_CA16_2397"), 
                          level='CSD', geo_format = "sf")

# Simplify to only needed variables
median_income <- census_data_csd %>% 
  as_tibble() %>% 
  select(CSDuid = GeoUID, contains("median"), Population) %>% 
  mutate(CSDuid = parse_number(CSDuid)) %>% 
  rename(hhld_median_inc = 2)
```

```{r}
library(haven)
library(tidyverse)
# download Access data SPSS (.sav) file generated by MDL (restricted) from website
f <- file.choose()
dataset = read_sav(f)

postcode <- dataset %>% 
  select(PC, CSDuid)
```

```{r}
# Check NAs
# median income
num_na <-sapply(median_income, function(x) sum(length(which(is.na(x)))))
knitr::kable(data.frame(num_na), caption = "Number of missing values for each variable in median_income")
```

```{r}
# Check NAs
# postcode
num_na <-sapply(postcode, function(x) sum(length(which(is.na(x)))))
knitr::kable(data.frame(num_na), caption = "Number of missing values for each variable in postcode")
```

```{r}
# Check NAs
num_na_1 <-sapply(cust_dev, function(x) sum(length(which(is.na(x)))))
num_na_2 <-sapply(cust_sleep, function(x) sum(length(which(is.na(x)))))
num_na_3 <-sapply(customer, function(x) sum(length(which(is.na(x)))))
num_na_4 <-sapply(device, function(x) sum(length(which(is.na(x)))))

knitr::kable(data.frame(num_na_1), caption = "Number of missing values for each variable in cust_dev")
knitr::kable(data.frame(num_na_2), caption = "Number of missing values for each variable in cust_sleep")
knitr::kable(data.frame(num_na_3), caption = "Number of missing values for each variable in customer")
knitr::kable(data.frame(num_na_4), caption = "Number of missing values for each variable in device")

```



```{r, warning=FALSE}
library(eeptools)
# dataset containing all customers

data <- full_join(cust_dev, customer, by = "cust_id") %>%
  left_join(device, by = "dev_id")

# calculate age
data <- data %>%  
  mutate(age = age_calc(dob,units = "years")) %>% 
  mutate(age_group = case_when(age >= 70 ~ "over 70", 
                               60 <= age && age < 70 ~ "60 ~ 70",
                               50 <= age && age< 60 ~ "50 ~ 60", 
                               40 <= age && age < 50 ~ "40 ~ 50",
                               30 <= age && age < 40 ~ "30 ~ 40",
                               20 <= age && age < 30 ~ "20 ~ 30",
                               20 > age ~ "under 20",))

# join postal code dataset with median income
postal_income <- full_join(postcode, median_income, by = "CSDuid") %>%
  rename(postcode = PC)

# match median income with each customer by postal code

data <- left_join(data,postal_income, by = "postcode")

data <- data %>% 
  mutate(customer_type = case_when(line == "Active" || line == "Advance" ~ "New",
                                   TRUE ~ "Traditional",))


# dataset containing only customers using advance product
advance_data <- data %>%
  filter(line == "Advance")

# dataset containing only customers using active product
active_data <- data %>%
  filter(line == "Active")

# dataset containing both advance and active
advance_active <- data %>%
  filter(line == "Active"|line == "Advance")
```

```{r}
# Check NAs after joining
num_na_data <-sapply(data, function(x) sum(length(which(is.na(x)))))
knitr::kable(data.frame(num_na_data), caption = "Number of missing values for each variable in data")

num_na_advance_active <-sapply(advance_active, function(x) sum(length(which(is.na(x)))))
knitr::kable(data.frame(num_na_advance_active), caption = "Number of missing values for each variable in data")
```


```{r}
# EDA

# age
hist(data$age, breaks = 20)
hist(advance_data$age, breaks = 20)
hist(active_data$age, breaks = 20)
# an age gap in active data
hist(advance_active$age)
```

```{r}
# sex
ggplot(data, aes(x = sex, fill = age_group)) + geom_bar() + ggtitle("Full dataset")
ggplot(advance_data, aes(x = sex, fill = age_group)) + geom_bar() + ggtitle("Advance custormer")
ggplot(active_data, aes(x = sex, fill = age_group)) + geom_bar() + ggtitle("Active custormer")
ggplot(advance_active, aes(x= sex, fill = age_group))+ geom_bar + ggtitle("Active and Advance customer")

sex_proportion_full<- data %>%
  group_by(sex) %>%
  summarise(prop = n()/29372)
sex_count_full<- table(data$age_group, data$sex)

sex_proportion_adv<- advance_data %>%
  group_by(sex) %>%
  summarise(prop = n()/12321)
sex_count_adv <- table(advance_data$age_group, advance_data$sex)

sex_proportion_act <- active_data %>%
  group_by(sex) %>%
  summarise(prop = n()/3308)
sex_count_act <-table(active_data$age_group, active_data$sex)
# similar result of 57% female and 40% male


sex_proportion_act_adv <- advance_active %>% 
  group_by(sex) %>% 
  summarise(prop = n() / nrow(advance_active))
sex_count_act_adv <- tabel(advance_active$age_group, advance_active$sex)

            
            
```

```{r}
# emoji
ggplot(data, aes(x = emoji_modifier, fill = sex)) + geom_bar()
ggplot(advance_data, aes(x = emoji_modifier, fill = sex)) + geom_bar()
ggplot(active_data, aes(x = emoji_modifier, fill = sex)) + geom_bar()
```

```{r}
ggplot(data, aes(x = emoji_modifier, fill = age_group)) + geom_bar()
ggplot(advance_data, aes(x = emoji_modifier, fill = age_group)) + geom_bar()
ggplot(active_data, aes(x = emoji_modifier, fill = age_group)) + geom_bar()
```

```{r}
# device name
ggplot(data, aes(x = device_name, fill = sex)) + geom_bar() + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
ggplot(advance_data, aes(x = device_name, fill = sex)) + geom_bar() + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
ggplot(active_data, aes(x = device_name, fill = sex)) + geom_bar() + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```

```{r}
ggplot(data, aes(x = device_name, fill = age_group)) + geom_bar() + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
ggplot(advance_data, aes(x = device_name, fill = age_group)) + geom_bar() + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
ggplot(active_data, aes(x = device_name, fill = age_group)) + geom_bar() + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```
```{r}
ggplot(data, aes(x = age, y = hhld_median_inc, color = line)) + geom_smooth()
ggplot(advance_active, aes(x = age, y = hhld_median_inc, color = line)) + geom_smooth()
ggplot(advance_data, aes(x = age, y = hhld_median_inc, color = emoji_modifier)) + geom_smooth()
ggplot(active_data, aes(x = age, y = hhld_median_inc, color = emoji_modifier)) + geom_smooth()
```

```{r}
hist(data$hhld_median_inc, breaks = 100, xlim = c(40000,200000))
hist(advance_data$hhld_median_inc, breaks = 100, xlim = c(40000,120000))
hist(active_data$hhld_median_inc, breaks = 50, xlim = c(40000,120000))

```

```{r}
ggplot(data, aes(x = hhld_median_inc, color = sex, )) + geom_bar()  +
    scale_x_continuous(breaks = 1:50) + facet_wrap(~emoji_modifier)
```
```{r}
# line
ggplot(data, aes(x = line, fill = age_group)) + geom_bar() + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
ggplot(advance_data, aes(x = line, fill = age_group)) + geom_bar() + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
ggplot(active_data, aes(x = line, fill = age_group)) + geom_bar() + theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```

```{r}
ggplot(data, aes(x= line, fill = sex)) + geom_bar()
```

```{r}
# How is the age of the new customer different from the traditional customer
ggplot(data, aes(x = customer_type, y = age)) + geom_boxplot()


# how is the age of new customer different from the traditional customer
age_group <- table(data$age_group, data$line)
age_group
customer_type <- table(data$age_group, data$customer_type)
customer_type
```

```{r}
# how is new_customer sex
sex <- table(data$customer_type, data$sex)
sex
```



